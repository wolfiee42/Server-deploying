name: Deploy to Production

on:
    push:
        branches:
            - main

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Login in to Docker Hub
              uses: docker/login-action@v2
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and Push Docker image
              uses: docker/build-push-action@v4
              with:
                context: .
                push: true
                tags: ${{ secrets.DOCKERHUB_USERNAME }}/deploy-server-2:latest

                
    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to VPS
              uses: appleboy/ssh-action@v0.1.10
              with: 
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USER }}
                key: ${{ secrets.KEY }}
                script: |
                    echo "Stopping the project"
                    docker stop deploy-server-2 || true

                    echo "Removing the project"
                    docker rm deploy-server-2 || true

                    echo "Pulling latest changes"
                    docker pull ${{ secrets.DOCKERHUB_USERNAME }}/deploy-server-2:latest

                    echo "Starting the project"
                    docker run -d --name deploy-server-2 -p 8001:8001 ${{ secrets.DOCKERHUB_USERNAME }}/deploy-server-2:latest
                    
                    echo "Deployment completed successfully"